---
sidebar_label: Microsoft Sentinel Advanced Integration
---

import ImportantConfigFiles from '../reusable/examples/important-config-files.mdx';

# Microsoft Sentinel Advanced Integration with ASIM Normalization

## Synopsis

This tutorial demonstrates advanced Microsoft Sentinel integration using DataStream's native Microsoft Sentinel capabilities, including automated DCR (Data Collection Rules) creation, ASIM (Advanced Security Information Model) normalization, and multi-table routing. You'll learn to optimize data ingestion costs, implement schema-aware processing, and leverage Sentinel's advanced analytics capabilities.

**Prerequisites:**

- **Azure** subscription with **Sentinel** workspace
- _Service Principal_ with appropriate permissions for DCR management
- Understanding of **Azure Monitor**, DCRs, and ASIM schema
- Knowledge of KQL (Kusto Query Language) for analytics

**Configuration files used:**

- `azure-sentinel-advanced.yml` - Main configuration with DCR automation
- `asim-normalization.yml` - ASIM schema mappings

**Sample data:**

- Various log types (Windows Events, Syslog, Network logs)
- Sample ASIM-normalized events

## Scenario

Enterprise security teams need to optimize their Microsoft Sentinel deployment for cost-efficiency while maintaining comprehensive security monitoring. This tutorial implements advanced Sentinel integration that:

- **Automated DCR management** - Creates and manages Data Collection Rules programmatically
- **ASIM normalization** - Transforms logs to Advanced Security Information Model standards
- **Multi-table routing** - Intelligently routes different event types to optimal Sentinel tables
- **Cost optimization** - Minimizes ingestion costs through intelligent data management
- **Schema enforcement** - Ensures data quality and compatibility with Sentinel analytics
- **Custom table creation** - Creates specialized tables for unique data types

**Data flow:**
Raw Logs → ASIM Normalization → DCR Routing → Microsoft Sentinel Tables → Analytics Rules

**Techniques demonstrated:**
- Azure authentication and DCR automation
- ASIM schema transformation
- Multi-table data routing
- Cost-optimized ingestion strategies
- Custom analytics table creation

## Setup

### Key Configuration Components

- **Device**: Multi-source log collection with Azure integration
- **Pipeline**: ASIM normalization and Sentinel preparation
- **Target**: Microsoft Sentinel with automated DCR management

### Quick Reference of Processors Used

|Processor|Purpose|Key Parameters|
|---|---|---|
|`normalize`|ASIM schema transformation|`format`, `target_schema`, `version`|
|`enforce_schema`|Schema validation|`schema`, `strict_mode`|
|`set`|Field mapping|`field`, `value`, `copy_from`|
|`script`|Custom transformations|`lang`, `source`|
|`iff`|Conditional routing|`if`, `then`, `else`|

### Expected Input/Output Formats

**Input**: Various log formats (Syslog, Windows Events, CEF, JSON)
**Output**: ASIM-normalized events ready for Microsoft Sentinel ingestion

## Trial

<ImportantConfigFiles />

Create a configuration file named `azure-sentinel-advanced.yml` in your working directory.

### Step 1: Configure Azure Authentication

```yml title="azure-sentinel-advanced.yml"
# Global Azure configuration
azure:
  tenant_id: "your-tenant-id"
  client_id: "your-service-principal-id"
  client_secret: "your-service-principal-secret"
  subscription_id: "your-subscription-id"
  resource_group: "your-sentinel-rg"
  workspace_name: "your-sentinel-workspace"
  
  # DCR management settings
  dcr_location: "East US"
  dcr_tags:
    environment: "production"
    team: "security"
    cost_center: "sec001"
```

:::warning Security Warning
**Never commit real Azure credentials to source control!** 

Replace the placeholder values above with your actual Azure credentials, but ensure you:
- Use environment variables or secure configuration management tools for production deployments
- Store credentials in secure key vaults (Azure Key Vault, HashiCorp Vault, etc.)
- Never share configuration files containing real credentials publicly
- Add `*.yml` and `*.yaml` files with credentials to your `.gitignore` file
- Consider using Azure Managed Identity for authentication when possible

For development, you can use environment variable substitution like `tenant_id: "${AZURE_TENANT_ID}"` instead of hardcoded values.
:::

```yml
devices:
  # Windows Event logs
  - id: 1
    name: windows_security_events
    type: syslog
    status: true
    properties:
      protocol: tcp
      address: 0.0.0.0
      port: 5140
      tag: windows_security
      
  # Network device logs
  - id: 2
    name: network_device_logs
    type: syslog
    status: true
    properties:
      protocol: udp
      address: 0.0.0.0
      port: 5141
      tag: network_devices
      
  # Application logs
  - id: 3
    name: application_logs
    type: file
    status: true
    properties:
      path: "/var/log/applications/*.json"
      follow: true
      multiline: false
      tag: applications
```

### Step 2: Configure Microsoft Sentinel Target with DCR Automation

```yml title="azure-sentinel-advanced.yml"
targets:
  # Microsoft Sentinel with automated DCR creation
  - name: sentinel_asim_events
    type: microsoft-sentinel
    status: true
    properties:
      # Azure connection
      tenant_id: "{{azure.tenant_id}}"
      client_id: "{{azure.client_id}}"
      client_secret: "{{azure.client_secret}}"
      subscription_id: "{{azure.subscription_id}}"
      resource_group: "{{azure.resource_group}}"
      workspace_name: "{{azure.workspace_name}}"
      
      # DCR automation
      auto_create_dcr: true
      dcr_name_prefix: "DataStream-ASIM"
      dcr_location: "{{azure.dcr_location}}"
      
      # ASIM table mappings
      table_mappings:
        - source_type: "authentication_events"
          target_table: "ASimAuthenticationEventLogs"
          schema_version: "0.2.6"
          
        - source_type: "network_sessions"
          target_table: "ASimNetworkSessionLogs"
          schema_version: "0.2.6"
          
        - source_type: "dns_activities"
          target_table: "ASimDnsActivityLogs"
          schema_version: "0.2.6"
          
        - source_type: "audit_events"
          target_table: "ASimAuditEventLogs"
          schema_version: "0.2.6"
          
        - source_type: "process_events"
          target_table: "ASimProcessEventLogs"
          schema_version: "0.2.6"
      
      # Cost optimization
      batch_size: 1000
      batch_timeout: 30s
      compression: gzip
      
      # Error handling
      retry_attempts: 3
      retry_delay: 5s
      dead_letter_queue: true
      
  # Custom table for proprietary events
  - name: sentinel_custom_events
    type: microsoft-sentinel
    status: true
    properties:
      tenant_id: "{{azure.tenant_id}}"
      client_id: "{{azure.client_id}}"
      client_secret: "{{azure.client_secret}}"
      subscription_id: "{{azure.subscription_id}}"
      resource_group: "{{azure.resource_group}}"
      workspace_name: "{{azure.workspace_name}}"
      
      # Custom table configuration
      custom_table_name: "VirtualMetricEvents_CL"
      auto_create_table: true
      table_retention_days: 730
      
      # Schema definition for custom table
      custom_schema:
        columns:
          - name: "TimeGenerated"
            type: "datetime"
          - name: "EventType"
            type: "string"
          - name: "SourceSystem"
            type: "string"
          - name: "EventData"
            type: "dynamic"
          - name: "RiskScore"
            type: "int"
          - name: "ProcessedBy"
            type: "string"
```

### Step 3: Configure ASIM Normalization Pipeline

```yml title="azure-sentinel-advanced.yml"
pipelines:
  # Windows Authentication Events to ASIM
  - name: windows_auth_to_asim
    processors:
      # Parse Windows Event Log
      - grok:
          field: message
          patterns:
            - "EventCode=(?<event_code>\\d+).*?TargetUserName=(?<target_user>[^\\s]+).*?IpAddress=(?<source_ip>[0-9\\.]+).*?LogonType=(?<logon_type>\\d+)"
          ignore_failure: true
      
      # Normalize to ASIM Authentication schema
      - normalize:
          format: asim
          target_schema: authentication_event
          version: "0.2.6"
          mappings:
            # Required ASIM fields
            EventType: 
              value: "Logon"
              if: "event_code in ['4624', '4625']"
            EventResultSuccess:
              value: "Success"
              if: "event_code == '4624'"
            EventResultFailure:
              value: "Failure"
              if: "event_code == '4625'"          EventResultDetails:
              value: "{{event_code}}"
            
            # Actor information
            ActorUsername: "{{target_user}}"
            ActorUsernameType: "Windows"
            ActorUserType: "Regular"
            
            # Source information
            SrcIpAddr: "{{source_ip}}"
            SrcPortNumber: null
            
            # Target information
            TargetHostname: "{{computer_name}}"
            TargetAppName: "Windows"
            TargetAppType: "OperatingSystem"
            
            # Authentication details
            LogonMethod:
              value: "Interactive"
              if: "logon_type == '2'"
            LogonMethod:
              value: "Network"
              if: "logon_type == '3'"
            LogonMethod:
              value: "RemoteInteractive"
              if: "logon_type == '10'"
            
            # Timestamps
            EventStartTime: "{{normalized_timestamp}}"
            EventEndTime: "{{normalized_timestamp}}"
            
            # Metadata
            EventVendor: "Microsoft"
            EventProduct: "Windows"
            EventSchema: "Authentication"
            EventSchemaVersion: "0.2.6"
      
      # Add event classification
      - set:
          field: event_classification
          value: "authentication_events"
      
      # Add risk scoring
      - set:
          field: risk_score
          value: 10
          if: "EventResult == 'Failure'"
      
      - set:
          field: risk_score
          value: 5
          if: "LogonMethod == 'RemoteInteractive'"
      
      - set:
          field: risk_score
          value: 1
          if: "risk_score == null"

  # Network logs to ASIM Network Session
  - name: network_to_asim_session
    processors:
      # Parse network device log (example for Cisco ASA)
      - grok:
          field: message
          patterns:
            - "%{CISCOFW106001}"
            - "%{CISCOFW106023}"
          pattern_definitions:
            CISCOFW106001: ".*Built %{WORD:connection_type} connection %{INT:connection_id} for %{DATA:src_interface}:%{IP:src_ip}/%{INT:src_port} \\(%{IP:src_translated_ip}/%{INT:src_translated_port}\\) to %{DATA:dst_interface}:%{IP:dst_ip}/%{INT:dst_port}.*"
            CISCOFW106023: ".*Deny %{WORD:protocol} src %{DATA:src_interface}:%{IP:src_ip}/%{INT:src_port} dst %{DATA:dst_interface}:%{IP:dst_ip}/%{INT:dst_port}.*"
      
      # Normalize to ASIM Network Session
      - normalize:
          format: asim
          target_schema: network_session
          version: "0.2.6"
          mappings:
            # Event information
            EventType: "NetworkSession"
            EventResult:
              value: "Success"
              if: "connection_type != null"
            EventResult:
              value: "Failure"
              if: "message contains 'Deny'"
            
            # Source information
            SrcIpAddr: "{{src_ip}}"
            SrcPortNumber: "{{src_port}}"
            SrcNatIpAddr: "{{src_translated_ip}}"
            SrcNatPortNumber: "{{src_translated_port}}"
            
            # Destination information
            DstIpAddr: "{{dst_ip}}"
            DstPortNumber: "{{dst_port}}"
            
            # Protocol information
            NetworkProtocol: "{{protocol}}"
            NetworkDirection: "Outbound"
            
            # Device information
            DvcHostname: "{{device_hostname}}"
            DvcIpAddr: "{{device_ip}}"
            
            # Session information
            NetworkSessionId: "{{connection_id}}"
            
            # Timestamps
            EventStartTime: "{{normalized_timestamp}}"
            EventEndTime: "{{normalized_timestamp}}"
            
            # Metadata
            EventVendor: "Cisco"
            EventProduct: "ASA"
            EventSchema: "NetworkSession"
            EventSchemaVersion: "0.2.6"
      
      - set:
          field: event_classification
          value: "network_sessions"

  # DNS logs to ASIM DNS Activity
  - name: dns_to_asim_activity
    processors:
      # Parse DNS query log
      - grok:
          field: message
          patterns:
            - "%{TIMESTAMP_ISO8601:timestamp} client %{IP:client_ip}#%{INT:client_port}: query: %{HOSTNAME:query_name} IN %{WORD:query_type}"
      
      # Normalize to ASIM DNS Activity
      - normalize:
          format: asim
          target_schema: dns_activity
          version: "0.2.6"
          mappings:
            # Event information
            EventType: "Query"
            EventResult: "Success"
            
            # Source information
            SrcIpAddr: "{{client_ip}}"
            SrcPortNumber: "{{client_port}}"
            
            # DNS information
            DnsQuery: "{{query_name}}"
            DnsQueryType: "{{query_type}}"
            DnsQueryTypeName: "{{query_type}}"
            
            # Timestamps
            EventStartTime: "{{normalized_timestamp}}"
            EventEndTime: "{{normalized_timestamp}}"
            
            # Metadata
            EventVendor: "BIND"
            EventProduct: "DNS"
            EventSchema: "Dns"
            EventSchemaVersion: "0.2.6"
      
      - set:
          field: event_classification
          value: "dns_activities"

  # Custom events pipeline
  - name: custom_events_processing
    processors:
      # Process custom application events
      - json:
          field: message
          add_to_root: true
      
      # Add custom processing logic
      - script:
          lang: javascript
          source:|
            // Custom risk scoring logic
            var riskScore = 0;
            
            if (event_type === 'security_violation') {
              riskScore += 50;
            }
            if (user_privileges === 'admin') {
              riskScore += 20;
            }
            if (source_ip && !source_ip.startsWith('192.168.')) {
              riskScore += 15; // External IP
            }
            
            risk_score = Math.min(riskScore, 100);
            
            // Create custom event structure
            custom_event_data = {
              event_id: event_id,
              event_type: event_type,
              risk_score: risk_score,
              source_system: 'VirtualMetric DataStream',
              processed_timestamp: new Date().toISOString(),
              original_data: {
                application: application_name,
                user: user_name,
                action: user_action,
                details: event_details
              }
            };
      
      - set:
          field: event_classification
          value: "custom_events"
```

### Step 4: Configure Intelligent Routing

```yml title="azure-sentinel-advanced.yml"
routes:
  # Windows Authentication Events
  - name: windows_auth_route
    devices:
      - name: windows_security_events
    pipelines:
      - name: windows_auth_to_asim
    targets:
      - name: sentinel_asim_events
        if: "event_classification == 'authentication_events'"
    
    # Optimize for authentication events
    batch_processing: true
    batch_size: 500
    batch_timeout: 15s
    
  # Network Session Events
  - name: network_session_route
    devices:
      - name: network_device_logs
    pipelines:
      - name: network_to_asim_session
    targets:
      - name: sentinel_asim_events
        if: "event_classification == 'network_sessions'"
    
    # Batch for network efficiency
    batch_processing: true
    batch_size: 1000
    batch_timeout: 30s
    
  # DNS Activity Events
  - name: dns_activity_route
    devices:
      - name: network_device_logs
    pipelines:
      - name: dns_to_asim_activity
    targets:
      - name: sentinel_asim_events
        if: "event_classification == 'dns_activities'"
        
  # Custom Events
  - name: custom_events_route
    devices:
      - name: application_logs
    pipelines:
      - name: custom_events_processing
    targets:
      - name: sentinel_custom_events
        if: "event_classification == 'custom_events'"
```

### Step 5: Start Microsoft Sentinel Integration

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
    ```PowerShell
    .\vmetric-director -console
    ```
  </TabItem>
  <TabItem value="bash" label="Bash">
    ```bash
    ./vmetric-director -console
    ```
  </TabItem>
</Tabs>

### Step 6: Verify DCR Creation

Monitor the logs for DCR creation:

```console
[2025-01-12 10:30:45] [Information] [azure-sentinel] Creating DCR: DataStream-ASIM-Authentication
[2025-01-12 10:30:46] [Information] [azure-sentinel] DCR created successfully: /subscriptions/.../dataCollectionRules/DataStream-ASIM-Authentication
[2025-01-12 10:30:47] [Information] [azure-sentinel] Stream configured: Microsoft-ASimAuthenticationEventLogs
[2025-01-12 10:30:48] [Information] [azure-sentinel] Table mapping verified: ASimAuthenticationEventLogs
```

### Step 7: Verify ASIM Normalized Data

Example ASIM Authentication Event output:

```json
{
  "EventType": "Logon",
  "EventResult": "Success",
  "EventResultDetails": "4624",
  "ActorUsername": "jdoe",
  "ActorUsernameType": "Windows",
  "ActorUserType": "Regular",
  "SrcIpAddr": "192.168.1.50",
  "TargetHostname": "WORKSTATION01",
  "TargetAppName": "Windows",
  "TargetAppType": "OperatingSystem",
  "LogonMethod": "Interactive",
  "EventStartTime": "2025-01-12T10:30:45Z",
  "EventEndTime": "2025-01-12T10:30:45Z",
  "EventVendor": "Microsoft",
  "EventProduct": "Windows",
  "EventSchema": "Authentication",
  "EventSchemaVersion": "0.2.6",
  "risk_score": 1,
  "event_classification": "authentication_events"
}
```

### Step 8: Create KQL Analytics Rules

In Microsoft Sentinel, create analytics rules using the normalized data:

```kql
// High-risk authentication failures
ASimAuthenticationEventLogs
|where EventResult == "Failure"
|where SrcIpAddr !startswith "192.168."
|summarize FailureCount = count() by ActorUsername, SrcIpAddr, bin(TimeGenerated, 5m)
|where FailureCount >= 5
|project TimeGenerated, ActorUsername, SrcIpAddr, FailureCount

// Suspicious network sessions
ASimNetworkSessionLogs
|where EventResult == "Success"
|where DstPortNumber in (22, 3389, 5985) // SSH, RDP, WinRM
|where SrcIpAddr !startswith "192.168."
|summarize ConnectionCount = count() by SrcIpAddr, DstPortNumber, bin(TimeGenerated, 1h)
|where ConnectionCount >= 10
```

## Monitoring

### Key Metrics to Observe

1. **DCR Status**: Successful creation and configuration of Data Collection Rules
2. **Ingestion Costs**: Monitor Microsoft Sentinel data ingestion charges
3. **Schema Compliance**: ASIM normalization success rates
4. **Query Performance**: Analytics rule execution times
5. **Data Quality**: Field population rates and validation errors

### Cost Optimization Strategies

- **Table Selection**: Route events to most cost-effective tables
- **Batch Processing**: Optimize ingestion batch sizes
- **Data Retention**: Configure appropriate retention periods
- **Sampling**: Implement intelligent sampling for high-volume sources
- **Filtering**: Remove unnecessary fields before ingestion

### Microsoft Sentinel Analytics

Leverage ASIM data for advanced analytics:

```kql
// User behavior analytics across multiple data sources
let AuthEvents = ASimAuthenticationEventLogs
|where TimeGenerated > ago(24h)
|project TimeGenerated, ActorUsername, SrcIpAddr, EventResult;

let NetworkEvents = ASimNetworkSessionLogs
|where TimeGenerated > ago(24h)
|project TimeGenerated, SrcIpAddr, DstIpAddr, NetworkProtocol;

AuthEvents
|join kind=inner (NetworkEvents) on SrcIpAddr
|summarize AuthAttempts = count(), UniqueDestinations = dcount(DstIpAddr) 
  by ActorUsername, SrcIpAddr
|where AuthAttempts > 10 or UniqueDestinations > 5
```

### Common Troubleshooting

**Issue**: DCR creation failures

- Verify Azure permissions for service principal
- Check subscription and resource group settings
- Validate Azure resource naming conventions

**Issue**: Schema validation errors

- Review ASIM field mappings
- Check data type conversions
- Verify required field population

**Issue**: High ingestion costs

- Implement data sampling
- Optimize batch sizes
- Review table selection strategy

### Performance Monitoring

Monitor Azure integration performance:

```console
[2025-01-12 10:30:45] [Information] [azure-sentinel] Batch sent: 1000 events to ASimAuthenticationEventLogs
[2025-01-12 10:30:46] [Information] [azure-sentinel] Ingestion latency: 2.3 seconds average
[2025-01-12 10:30:47] [Information] [azure-sentinel] Cost estimate: $0.45 for current batch
[2025-01-12 10:30:48] [Information] [azure-sentinel] Schema compliance: 98.7% success rate
```

:::caution
Microsoft Sentinel ingestion incurs costs based on data volume. Monitor usage carefully and implement appropriate cost controls for production deployments.
:::
