# Pre-processing

This is the stage before routing. Pipelines attached to a source prepare the data for downstream work such as indexing or analysis.

Pre-processing helps organizations reduce their costs by optimizing their data ingestion before the data reaches the routing stage.

## Key Benefits

The motivation for using pre-processing is summarized below by detailing its various aspects.

### Data Reduction

Lower downstream costs and improve performance through:

- **Field Removal**: Remove unnecessary fields using the `remove` processor
- **String Modifications**: Clean up text with `gsub` processor for pattern replacements
- **Conditional Dropping**: Use `drop` processor with conditions to filter events
- **Data Restructuring**: Reorganize fields with `rename` processor

**Example** - Basic data reduction:

```yaml
pipeline:
  processors:
    - remove:
        field: ["debug_info", "internal_id"]
    - drop:
        if: "ctx.severity == 'debug'"
```

### Normalization 

Convert diverse log formats into consistent structures:

- **Field Standardization**: Use `normalize` processor to convert between ECS, CIM, and ASIM formats
- **Field Restructuring**: Apply `dot_nester` processor to flatten or restructure nested objects
- **Case Normalization**: Standardize text case with `uppercase` and `lowercase` processors
- **Value Parsing**: Extract structured data with `csv`, `kv`, `grok` processors

**Example** - Format normalization:

```yaml
pipeline:
  processors:
    - normalize:
        target_format: "ecs"
    - dot_nester:
        field: "nested_data"
        target_field: "flattened"
```

### Enrichment

Add context using:

- **Geo Information**: Add location data with `geoip` processor
- **Data Correlation**: Enrich data using `enrich` processor with lookup tables
- **URI Processing**: Extract components with `uri_parts` processor
- **Device Information**: Parse user agent strings with `user_agent` processor

**Example** - Data enrichment:

```yaml
pipeline:
  processors:
    - geoip:
        field: source.ip
        target_field: geo
    - enrich:
        lookup_table: ["threat_intel.csv"]
        query: "SELECT * FROM lookup_table WHERE ip = _ingest.source.ip"
```

### String Processing

Transform text data with:

- **Pattern Replacement**: Use `gsub` for regex-based substitutions
- **Field Splitting**: Break strings into arrays with `split` processor
- **Array Operations**: Combine array elements with `join` processor
- **Case Conversion**: Modify text case with `uppercase`/`lowercase` processors

**Example** - String transformations:

```yaml
pipeline:
  processors:
    - gsub:
        field: message
        pattern: "secret-\\d+"
        replacement: "REDACTED"
    - split:
        field: tags
        separator: ","
```

## Best Practices

1. **Processor Order**
   - Place critical transformations first (removal, dropping)
   - Group related operations together
   - Perform enrichment last

2. **Performance Optimization**
   - Use efficient regex patterns in `gsub` and `grok`
   - Cache lookup results with `enrich` processor
   - Monitor pipeline throughput

3. **Data Quality**
   - Validate transformations
   - Handle errors appropriately using `ignore_failure`
   - Monitor field presence and transformations

4. **Maintenance**
   - Document pipeline configurations
   - Review and update enrichment data
   - Monitor processor performance

:::warning
Complex processing chains can impact throughput. Monitor resource usage and adjust pipeline complexity accordingly.
:::

:::tip
Start with essential processors and add complexity incrementally while monitoring impact on performance.
:::

## Error Handling

Use these strategies for robust processing:

1. **Ignore Missing Fields**
   ```yaml
   processors:
     - gsub:
         field: optional_field
         pattern: "sensitive-\\d+"
         replacement: "REDACTED"
         ignore_missing: true
   ```

2. **Handle Failures**
   ```yaml
   processors:
     - grok:
         field: message
         patterns: ["%{TIMESTAMP_ISO8601:timestamp}"]
         ignore_failure: true
         on_failure:
           - append:
               field: tags
               value: parsing_failed
   ```

3. **Conditional Processing**
   ```yaml
   processors:
     - normalize:
         target_format: "ecs"
         if: "ctx.format != 'ecs'"
   ```