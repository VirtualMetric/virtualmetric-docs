# Sentinel Integration

This section is intended as a guide to integrate **Director** with Microsoft Sentinel from the command line.

Open a **PowerShell** terminal with _Admin_ rights, and navigate to `<vm_root>`. Then, type the following on the command line and press <kb-short>Enter</kb-short>.

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell
  C:\<vm_root>\vmetric-director -sentinel
  ```
  </TabItem>
  <TabItem value="bash" label="Bash">
  ```bash
  ~/path/to/<vm_root>: ./vmetric-director -sentinel
  ```
  </TabItem>
</Tabs>

You will see the following output:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {4,8,9}
  C:\<vm_root>\vmetric-director -sentinel
  VirtualMetric - Microsoft Sentinel Integration

  Welcome to the Microsoft Sentinel Integration!

  Choose Authentication Method:

  > Browser Authentication
    Device Code Authentication
  
  Use up/down arrows to navigate and press enter to select.
  Press 'q' to quit.
  ```
  </TabItem>
</Tabs>

Select the authentication method you desire and press <kb-short>Enter</kb-short>. You will see the following prompt:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Authentication Successful!

  You have successfully authenticated!

  Press any key to proceed.
  ```
  </TabItem>
</Tabs>

After you press a key, the following prompt appears:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Integration Method

  How do you want to set up the integration?

  > Create a new Log Analytics Workspace
    Use an existing Log Analytics Workspace

  Use up/down arrows to navigate and press enter to select.
  Press 'b' to return, press 'q' to quit.
  ```
  </TabItem>
</Tabs>

Select the first option and press <kb-short>Enter</kb-short>. Next you will see the following prompt:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Select Subscription

  Choose the subscription you want to use:

  > <your_subscription>

  Use up/down arrows to navigate and press enter to select.
  Press 'b' to return, press 'q' to quit.
  ```
  </TabItem>
</Tabs>

Provide your _Azure Subscription_ name and press <kb-short>Enter</kb-short>. Next you will select a region:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Select Region

  Choose the region you want to use:

  > North Europe
    South Central US
    South India
    Southeast Asia
    UK South
    UK West
    West Europe
    West India
    West US
    West US 2
  
  Use up/down arrows to navigate and press enter to select.
  Press 'b' to return, press 'q' to quit.
  ```
  </TabItem>
</Tabs>

Select the region you desire and press <kb-short>Enter</kb-short>. You will now create a resource group:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Resource Group Option

  Choose how to manage the resource group:

  > Create a new Resource Group
    Use an existing Resource Group

  Use up/down arrows to navigate and press enter to select.
  Press 'b' to return, press 'q' to quit.
  ```
  </TabItem>
</Tabs>

Select the first option and press <kb-short>Enter</kb-short>. Now you will name your resource group:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Resource Group Name

  Enter the resource group name (default: vmetric):

  <your_group_name>
  
  Press enter to confirm.
  ```
  </TabItem>
</Tabs>

After you have entered `<your_group_name>` and pressed <kb-short>Enter</kb-short>, you will name your instance:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Instance Name

  Enter the instance name (default: vmetric-loganalytics):

  <your_instance_name>

  Press enter to confirm.
  ```
  </TabItem>
</Tabs>

Once you type `<your_instance_name>` and press <kb-short>Enter</kb-short>, **Director** begins to create your workspace and informs you that it is doing so:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Creating Workspace

  Please wait while we create your workspace...

  This may take a few minutes.

  Press 'b' to return, press 'q' to quit.
  ```
  </TabItem>
</Tabs>

Once the workspace is created, you will be prompted with the following:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Setup Complete

  Log Analytics Workspace 'your_instance_name' is ready for use.

  Press enter to continue with App Registration.

  Press 'b' to return, press 'q' to quit.
  ```
  </TabItem>
</Tabs>

When you press <kb-short>Enter</kb-short>, you will proceed to App Registration. This will involve authentication via the browser which will launch automatically. Once the integration process completes, you will be prompted with the following:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell {2}
  C:\<vm_root>\vmetric-director -sentinel
  Integration Complete

  VirtualMetric Target Configuration.

  targets:
    - name: sentinel
      type: sentinel
      properties:
        tenant_id: "<your-tenant-id>"
        client_id: "<your-client-id>"
        client_secret: "<your-client-secret>"
        endpoint: "https://<your-endpoint>"
        rule_id: "<rule-identifier>"

  Press 's' to save the configuration to the current path, press 'q' to quit.
  ```
  </TabItem>
</Tabs>

From this screen

- copy the sentinel information by pressing <kb-short>S</kb-short> and paste it into a text editor like **Notepad**

- then, open **File Explorer** and navigate to `<vm_root>\director\config\targets`. There, you will find the file named `sentinel.yml`. Open it with **Notepad**, and replace the `properties` section with the _properties_ block you have copied from the screen

{/* TODO: Bundan sonrasında bende film koptu. Azure ve ASIM tabloları nereden çıktı? */}

Once you have done this, switch to your browser and go to **Azure Portal: Data Collection Rules** and find "`vmetric-dcr-<your-instance-name>`" under it. Select **Data Sources** and verify that all the ASIM tables have been created automatically.

Now you can right-click `vmetric-director.exe` and select **Run as Administrator** from the context menu. **Director** will run as a service.

## Run: Checkpoint Simulation

Once again, open a **PowerShell** terminal with _Admin_ rights and cd to `<vm_root>`. Then type the executable name and press <kb-short>Enter</kb-short>.

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell
  C:\<vm_root>\vmetric-director
  ```
  </TabItem>
</Tabs>

The executable will start sending debug messages which you will see on the screen. Now open another **PowerShell** terminal with _Admin_ rights and again navigate to `<vm_root>`. This time, type the following and press <kb-short>Enter</kb-short>:

<Tabs>
  <TabItem value="powershell" label="PowerShell" default>
  ```PowerShell
  C:\<vm_root>\vmetric-generator -mode syslog -path test-logs-checkpoint.txt -count 1 -duration 1 -now
  ```
  </TabItem>
</Tabs>

You will see on the screen the number of messages sent by **Generator**.
