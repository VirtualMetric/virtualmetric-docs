import Synopsis from "@site/src/components/Synopsis";

import Table from '@site/src/components/Table';
import TableBody from '@site/src/components/Table/TableBody';
import TableHeader from '@site/src/components/Table/TableHeader';
import TableRow from '@site/src/components/Table/TableRow';
import TableCell from '@site/src/components/Table/TableCell';

# For Each

<Synopsis>
Runs a processor on each element of an array or object when the number of elements is unknown.
</Synopsis>

## Parameters

|Field|Required|Default|Description|
|---|---|---|---|
|`field`|Y|N/A|The field containing the array or object with two or more elements|
|`processor`|Y|N/A|The processor to run on each element|
|`description`|N|-|Explanatory note|
|`if`|N|-|Execute on this condition|
|`ignore_failure`|N|`false`|See [Handling Failures](../handling-failures.mdx)|
|`ignore_missing`|N|`false`|If `true` and `field` does not exist or is `null`, exit quietly without making any modifications|
|`on_failure`|N|-|See [Handling Failures](../handling-failures.mdx)|
|`on_success`|N|||
|`tag`|N|-|Identifier|

## Accessors

During iteration over an array, the current element's value is stored in the `_ingest._value` metadata field which contains the element along with its child fields, if any. These can be accessed using dot notation on this metadata field.

During iteration over an object, the current element's key is also stored as a string in `_ingest._key`.

Both of these can be accessed and modified during iteration.

## Failure Handling

If an element cannot be processed and no `on_failure` processor is specified, `foreach` exits silently leaving the entire array or object unmodified.

## Examples

### Arrays

**Input**:

```js
{
   "values" : ["foo", "bar", "baz"]
}
```

**Spec**:

```js
{
   "foreach" : {
      "field" : "values",
      "processor" : {
         "uppercase" : {
            "field" : "_ingest._value"
         }
      }
   }
}
```

**Output**:

```js
{
   "values" : ["FOO", "BAR", "BAZ"]
}
```

### Array of Objects

**Input**:

```js
{
   "things": [
      {
         "id": "1",
         "name": "foo"
      },
      {
         "id": "2",
         "name": "bar"
      }
   ]
}
```

**Spec**:

```js
{
   "foreach": {
      "field": "things",
         "processor": {
            "remove": {
            "field": "_ingest._value.id"
         }
      }
   }
}
```

**Output**:

```js
{
   "things": [
      {
         "name": "foo"
      },
      {
         "name": "bar"
      }
   ]
}
```

### Objects

**Input**:

```js
{
   "things" : {
      "foos" : {
         "size": 10,
         "display_name": "Foos"
      },
      "bars" : {
         "size": 20,
         "display_name": "Bars"
      },
      "quus" : {
         "size": 50,
         "display_name": ""
      }
   }
}
```

**Spec**:

```js
{
   "foreach": {
      "field": "things",
         "processor": {
         "uppercase": {
            "field": "_ingest._value.display_name"
         }
      }
   }
}
```

**Output**:

```js
{
   "things" : {
      "foos" : {
         "size" : 10,
         "display_name" : "FOOS"
      },
      "bars" : {
         "size" : 20,
         "display_name" : "BARS"
      },
      "quus" : {
         "size" : 50,
         "display_name" : ""
      }
   }
}
```

### Failures

The contained processor can have an `on_failure` definition that Use to send the document to the failure queue for review.

**Spec**:

```js
{
   "foreach" : {
      "field" : "things",
      "processor": {
         "remove": {
            "field" : "_value.id",
            "on_failure" : [
               {
                  "set" : {
                     "field": "_index",
                     "value": "failure_index"
                  }
               }
            ]
         }
      }
   }
}
```

In the event of a failure, elements processed so far will be updated.

---

<Table>
   <TableHeader columnNames={['Input', 'Spec', 'Output']} />
   <TableBody>
      <TableRow>
         <TableCell>
            ```json
            {
               "values" : ["foo", "bar", "baz"]
            }
            ```
         </TableCell>
         <TableCell>
            ```json
            {
               "foreach" : {
                  "field" : "values",
                  "processor" : {
                     "uppercase" : {
                        "field" : "_ingest._value"
                     }
                  }
               }
            }
            ```
         </TableCell>
         <TableCell>
            ```json
            {
               "values" : ["FOO", "BAR", "BAZ"]
            }
            ```
         </TableCell>
      </TableRow>
      <TableRow>
         <TableCell>
           ```json
            {
               "things": [
                  {
                     "id": "1",
                     "name": "foo"
                  },
                  {
                     "id": "2",
                     "name": "bar"
                  }
               ]
            }
            ```
         </TableCell>
         <TableCell>
            ```json
            {
               "foreach": {
                  "field": "things",
                     "processor": {
                     "uppercase": {
                        "field": "_ingest._value.display_name"
                     }
                  }
               }
            }
            ```
         </TableCell>
         <TableCell>
            ```json
            {
               "things" : {
                  "foos" : {
                     "size" : 10,
                     "display_name" : "FOOS"
                  },
                  "bars" : {
                     "size" : 20,
                     "display_name" : "BARS"
                  },
                  "quus" : {
                     "size" : 50,
                     "display_name" : ""
                  }
               }
            }
            ```
         </TableCell>
      </TableRow>
   </TableBody>
</Table>
