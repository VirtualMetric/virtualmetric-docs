# Normalization

Normalization is a critical stage connecting ingestion from sources and forwarding to targets used to coalesce log data from diverse sources into consistent formats, enabling unified handling across different logging systems.

## Log Formats

The processor supports several widely-used log formats:

### Generic

|Format|Notation|Key Identifier|Layout Characteristics|Example Fields|
|:-:|:-:|:-:|:-:|:-:|
|Elastic Common Schema (ECS)|Dot notation with lowercase|`@timestamp`|Hierarchical structure|`source.ip`, `network.direction`|
|Splunk Common Information Model (CIM)|Underscore with lowercase|`_time`|Flat structure|`src_ip`, `network_direction`|
|Advanced Security Information Model (ASIM)|PascalCase|`TimeGenerated`|Explicit names|`SourceIp`, `NetworkDirection`|

### Security-specific

|Format|Description|Key Identifier|Example Fields|
|:-:|:-:|:-:|:-:|
|Common Event Format (CEF)|ArcSight's standard format|`rt` (receiptTime)|`networkUser`, `sourceAddress`|
|Log Event Extended Format (LEEF)|IBM QRadar's format|`devTime`|`networkUser`, `srcAddr`|
|Common Security Log (CSL)|Microsoft Sentinel's format|`TimeGenerated`|`NetworkUser`, `SourceAddress`|

## Format Detection

Source formats can be automatically detected using certain characteristic fields, e.g.

|Context|Field|Format|
|--:|:--|:--|
|Timestamp|`@timestamp`|ECS|
||`_time`|CIM|
||`TimeGenerated`|ASIM/CSL
|Security|`rt`|CEF|
||`devTime`|LEEF|
|CSL detection|`TimeGenerated` + `LogSeverity`|CSL|
||`TimeGenerated` only|ASIM|

## Conversion

### Casing and Delimiters

Each format follows specific naming conventions:

<TermTable>
  <TermCol>**ECS**</TermCol>
  <DefCol>`source.ip`, `event.severity`</DefCol>

  <TermCol>**CIM**</TermCol>
  <DefCol>`src_ip`, `event_severity`</DefCol>

  <TermCol>**ASIM**</TermCol>
  <DefCol>`SourceIp`, `EventSeverity`</DefCol>

  <TermCol>**CEF**</TermCol>
  <DefCol>`sourceAddress`, `eventSeverity`</DefCol>

  <TermCol>**LEEF**</TermCol>
  <DefCol>`srcAddr`, `evtSev`</DefCol>

  <TermCol>**CSL**</TermCol>
  <DefCol>`SourceIP`, `EventSeverity`</DefCol>
</TermTable>

:::caution
Complex format conversions may impact performance.
:::

### Field Mapping

There are identifiable common network fields based on context across various formats:

<table>
  <tr><th></th><th colspan="3">Context</th></tr>
  <tr><td><b>Format</b></td><td>Source IP</td><td>Destination IP</td><td>Direction</td></tr>
  <tr><td style={{textAlign: "right"}}>`ecs`</td><td>`source.ip`</td><td>`destination.ip`</td><td>`network.direction`</td></tr>
  <tr><td style={{textAlign: "right"}}>`cim`</td><td>`src_ip`</td><td>`dest_ip`</td><td>`network_direction`</td></tr>
  <tr><td style={{textAlign: "right"}}>`asim`</td><td>`SourceIp`</td><td>`DstIp`</td><td>`NetworkDirection`</td></tr>
  <tr><td style={{textAlign: "right"}}>`cef`</td><td>`src`</td><td>`dst`</td><td>`networkDirection`</td></tr>
  <tr><td style={{textAlign: "right"}}>`leef`</td><td>`srcAddr`</td><td>`dstAddr`</td><td>`netDir`</td></tr>
  <tr><td style={{textAlign: "right"}}>`csl`</td><td>`SourceIp`</td><td>`DestinationIp`</td><td>`NetworkDirection`</td></tr>
</table>

## Configuration

### Basic

Convert from ECS to ASIM format:

```yaml
normalize:
  source_format: ecs
  target_format: asim
```

### Field-specific

Convert a specific network field:

```yaml
normalize:
  field: network_data
  source_format: cef
  target_format: ecs
```

### Auto-detection

Let the processor detect the source format:

```yaml
normalize:
  target_format: cim
```

## Pre-processing

Pre-processing is the stage before routing where pipelines attached to a source prepare the data for downstream work. It helps organizations reduce costs by optimizing data ingestion before reaching the routing stage.

### Key Operations

Pre-processing involves rendering data suitable for routing operations through:

#### Structural optimization

Fields are optimized by eliminating unnecessary ones with `remove`, and re-mapping relevant ones with `rename` for downstream handling. Strings are optimized for pattern replacement with `gsub`. Events are filtered conditionally using `drop`.

#### Data normalization

Converting diverse log formats into uniform structures using the normalization techniques described above in this document:

Fields are standardized with `normalize` for conversion between the ECS, CIM, ASIM, CEF, LEEF and CSL formats (see [Log Formats](#log-formats) and [Conversion](#conversion) sections). They are then restructured with `dot_nester` to flatten or regroup nested objects. Finally, they are parsed to extract structured data with `csv`, `kv`, or `grok`.

Values are formatted for uniform casing with `uppercase` and `lowercase`. Text data is transformed using `gsub` for regex-based substitutions. Fields are broken into arrays with `split`, and array elements are combined with `join`.

#### Enrichment

Multi-layering the context: Location data is adding with `geoip` for geographic information. Data is correlated with lookup tables using `enrich`. URI components are extracted with `uri_parts`. And user agent information is parsed with `user_agent`.

## Post-processing

Post-processing is the stage where pipelines attached to destinations perform final transformations before data reaches storage or analysis systems. These transformations ensure data meets destination-specific requirements and is optimized for storage efficiency.

### Key Operations

Post-processing involves rendering data suitable for destinations through:

- Fields are optimized for storage and queries using removal, renaming, restructuring, and format conversion. The latter two typically involve the use of the `dot_nester` and `normalize` processors (see [Conversion](#conversion) and [Field Mapping](#field-mapping) sections above).

- Data is directed to multiple destinations with conditional routing logic based on content. Failover scenarios are handled at this stage using the `reroute` processor.

  A typical case is _Microsoft Sentinel Integration_: data is prepared by converting to the ASIM format with `normalize` (see [Log Formats](#log-formats) table), parsing fields with `grok` or `kv`, and applying `network_direction` for traffic analysis.

- Time-related transformations such as timestamps converted with `date`, time-based indexes created with `date_index_name`, and timestamps cleaned with `gsub`.

:::warning
Heavy post-processing can impact delivery latency. Monitor and adjust based on performance requirements.
:::

## Best Practices

It is best to keep the following in mind during normalization:

- **Data Integrity** - Always validate transformed logs against originals, keep original fields when possible for debugging, and document format-specific transformations.

- **Performance** - Do the normalization early in the pipeline, cache results for lookup when possible, and monitor transformation overhead.

- **Error Handling** - Use `ignore_failure` and implement fallback mechanisms. Also, do not forget to test with diverse samples.
