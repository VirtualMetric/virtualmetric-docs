# Amazon MSK

<span className="theme-doc-version-badge badge badge--secondary">Amazon AWS</span><span className="theme-doc-version-badge badge badge--secondary">Message Queue</span>

## Synopsis

Creates a target that writes log messages to Amazon Managed Streaming for Apache Kafka (MSK) topics with support for batching, compression, and AWS authentication methods. The target handles message delivery efficiently with configurable batch limits based on size or event count. Amazon MSK is a fully managed Apache Kafka service on AWS.

## Schema

```yaml {1,3}
- name: <string>
  description: <string>
  type: amazonmsk
  pipelines: <pipeline[]>
  status: <boolean>
  properties:
    address: <string>
    port: <numeric>
    client_id: <string>
    topic: <string>
    algorithm: <string>
    username: <string>
    password: <string>
    compression: <string>
    compression_level: <string>
    acknowledgments: <string>
    allow_auto_topic_creation: <boolean>
    disable_idempotent_write: <boolean>
    max_bytes: <numeric>
    max_events: <numeric>
    batch_mode: <string>
    batch_separator: <string>
    field_format: <string>
    tls:
      status: <boolean>
      insecure_skip_verify: <boolean>
      min_tls_version: <string>
      max_tls_version: <string>
      cert_name: <string>
      key_name: <string>
      passphrase: <string>
    interval: <string|numeric>
    cron: <string>
    debug:
      status: <boolean>
      dont_send_logs: <boolean>
```

## Configuration

The following fields are used to define the target:

|Field|Required|Default|Description|
|---|---|---|---|
|`name`|Y||Target name|
|`description`|N|-|Optional description|
|`type`|Y||Must be `amazonmsk`|
|`pipelines`|N|-|Optional post-processor pipelines|
|`status`|N|`true`|Enable/disable the target|

### Amazon MSK Connection

|Field|Required|Default|Description|
|---|---|---|---|
|`address`|Y|-|MSK broker bootstrap server address (e.g., `b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com`)|
|`port`|N|`9092`|MSK broker port (9092 for plaintext, 9094 for SASL/SCRAM, 9098 for IAM)|
|`client_id`|N|-|Client identifier for connection tracking|
|`topic`|Y|-|Kafka topic name for message delivery|

### Authentication

|Field|Required|Default|Description|
|---|---|---|---|
|`algorithm`|N|`"none"`|Authentication mechanism: `none`, `plain`, `scram-sha-256`, `scram-sha-512`|
|`username`|N*|-|Username for SASL authentication|
|`password`|N*|-|Password for SASL authentication|

\* = Conditionally required when using SASL authentication.

:::note
For IAM authentication, use AWS IAM roles and policies. IAM authentication is configured at the AWS MSK cluster level and does not require username/password in the target configuration.
:::

### Producer Settings

|Field|Required|Default|Description|
|---|---|---|---|
|`compression`|N|`"none"`|Message compression: `none`, `gzip`, `snappy`, `lz4`, `zstd`|
|`compression_level`|N|-|Compression level (algorithm-specific)|
|`acknowledgments`|N|`"leader"`|Acknowledgment level: `none`, `leader`, `all`|
|`allow_auto_topic_creation`|N|`false`|Allow automatic topic creation if topic doesn't exist|
|`disable_idempotent_write`|N|`false`|Disable idempotent producer (not recommended)|

### Batch Configuration

|Field|Required|Default|Description|
|---|---|---|---|
|`max_bytes`|N|`0`|Maximum batch size in bytes (0 = unlimited)|
|`max_events`|N|`1000`|Maximum number of events per batch|
|`batch_mode`|N|`json`|Output format: `json` (single JSON per message), `json_batch` (array of JSON objects)|
|`batch_separator`|N|`\n`|Separator between messages when using json_batch mode|
|`field_format`|N|-|Data normalization format. See applicable <Topic id="pipelines-normalization-field-mapping">Normalization</Topic> section|

:::note
Batches are sent when either `max_bytes` or `max_events` limit is reached, whichever comes first.
:::

### TLS Configuration

|Field|Required|Default|Description|
|---|---|---|---|
|`tls.status`|N|`false`|Enable TLS/SSL encryption|
|`tls.insecure_skip_verify`|N|`false`|Skip certificate verification (not recommended)|
|`tls.min_tls_version`|N|`"tls1.2"`|Minimum TLS version: `tls1.2`, `tls1.3`|
|`tls.max_tls_version`|N|`"tls1.3"`|Maximum TLS version: `tls1.2`, `tls1.3`|
|`tls.cert_name`|N|`"cert.pem"`|Client certificate file name for mTLS|
|`tls.key_name`|N|`"key.pem"`|Private key file name for mTLS|
|`tls.passphrase`|N|-|Passphrase for encrypted private key|

### Scheduler

|Field|Required|Default|Description|
|---|---|---|---|
|`interval`|N|realtime|Execution frequency. See <Topic id="scheduling-interval-based">Interval</Topic> for details|
|`cron`|N|-|Cron expression for scheduled execution. See <Topic id="scheduling-cron-based">Cron</Topic> for details|

### Debug Options

|Field|Required|Default|Description|
|---|---|---|---|
|`debug.status`|N|`false`|Enable debug logging|
|`debug.dont_send_logs`|N|`false`|Process logs but don't send to target (testing)|

## Details

Amazon MSK is a fully managed Apache Kafka service on AWS. This target type allows you to connect to MSK clusters using the standard Kafka protocol.

### Authentication Methods

Amazon MSK supports multiple authentication methods:

**Unauthenticated Access (plaintext)**
- No authentication required
- Port: 9092
- Set `algorithm: "none"`
- Not recommended for production

**SASL/SCRAM Authentication**
- Username/password authentication stored in AWS Secrets Manager
- Port: 9094
- Supported algorithms: `scram-sha-256`, `scram-sha-512`
- TLS encryption recommended

**IAM Authentication**
- Uses AWS IAM roles and policies for authentication
- Port: 9098
- Configured at the AWS level, not in target configuration
- Requires AWS credentials configured on the DataStream host
- TLS encryption required

### Connection Requirements

MSK cluster bootstrap servers are available in the AWS MSK Console. The address format is typically:
```
b-1.clustername.xxxxxx.kafka.region.amazonaws.com
```

For multi-broker clusters, you can use any broker from the bootstrap server list.

### TLS Configuration

MSK supports both plaintext and TLS-encrypted connections:
- **Plaintext**: Port 9092 (unauthenticated) or 9094 (SASL/SCRAM)
- **TLS**: Port 9094 (SASL/SCRAM) or 9098 (IAM)

Enable TLS with `tls.status: true` for encrypted connections.

### Message Delivery Guarantees

The `acknowledgments` setting controls delivery guarantees:

|Level|Behavior|Use Case|
|---|---|---|
|`none`|No acknowledgment from broker|Maximum throughput, lowest durability|
|`leader`|Acknowledgment from partition leader only|Balanced throughput and durability|
|`all`|Acknowledgment from all in-sync replicas|Maximum durability|

### Compression

Message compression reduces network bandwidth and storage requirements:

|Algorithm|Compression Ratio|CPU Usage|Speed|
|---|---|---|---|
|`none`|None|Minimal|Fastest|
|`gzip`|High|High|Slow|
|`snappy`|Medium|Low|Fast|
|`lz4`|Medium|Low|Fast|
|`zstd`|High|Medium|Medium|

## Examples

### Basic Configuration (Unauthenticated)

The minimum configuration for an MSK target without authentication:

```yaml
targets:
  - name: basic_msk
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9092
      topic: "application-logs"
      algorithm: "none"
```

### With SASL/SCRAM-SHA-512

Configuration using SASL/SCRAM-SHA-512 authentication:

```yaml
targets:
  - name: msk_sasl
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9094
      topic: "authenticated-logs"
      algorithm: "scram-sha-512"
      username: "kafka-producer"
      password: "stored-in-secrets-manager"
      tls:
        status: true
```

### With SASL/SCRAM-SHA-256

Configuration using SASL/SCRAM-SHA-256 authentication:

```yaml
targets:
  - name: msk_scram256
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9094
      topic: "secure-logs"
      algorithm: "scram-sha-256"
      username: "kafka-user"
      password: "secure-password"
      compression: "snappy"
      tls:
        status: true
```

### IAM Authentication

Configuration for MSK with IAM authentication:

```yaml
targets:
  - name: msk_iam
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9098
      topic: "iam-logs"
      algorithm: "none"
      tls:
        status: true
```

:::note
For IAM authentication, configure AWS credentials on the DataStream host using environment variables, IAM role, or AWS credentials file. The IAM policy must grant appropriate Kafka permissions.
:::

### With Compression

Configuration with zstd compression:

```yaml
targets:
  - name: compressed_msk
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9094
      topic: "compressed-logs"
      algorithm: "scram-sha-256"
      username: "kafka-producer"
      password: "password-here"
      compression: "zstd"
      tls:
        status: true
```

### High Throughput

Configuration optimized for maximum throughput:

```yaml
targets:
  - name: high_throughput_msk
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9094
      topic: "high-volume-logs"
      algorithm: "scram-sha-512"
      username: "kafka-producer"
      password: "password-here"
      compression: "lz4"
      acknowledgments: "leader"
      max_bytes: 1048576
      max_events: 10000
      tls:
        status: true
```

### High Reliability

Configuration optimized for maximum durability:

```yaml
targets:
  - name: reliable_msk
    type: amazonmsk
    pipelines:
      - checkpoint
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9094
      topic: "critical-logs"
      algorithm: "scram-sha-512"
      username: "kafka-producer"
      password: "password-here"
      compression: "zstd"
      acknowledgments: "all"
      max_events: 100
      disable_idempotent_write: false
      tls:
        status: true
        min_tls_version: "tls1.3"
```

### With Field Normalization

Using field normalization for standard format:

```yaml
targets:
  - name: normalized_msk
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9094
      topic: "normalized-logs"
      algorithm: "scram-sha-256"
      username: "kafka-producer"
      password: "password-here"
      field_format: "cim"
      compression: "snappy"
      tls:
        status: true
```

### MSK Serverless

Configuration for MSK Serverless clusters:

```yaml
targets:
  - name: msk_serverless
    type: amazonmsk
    properties:
      address: "boot-abc123.c1.kafka-serverless.us-east-1.amazonaws.com"
      port: 9098
      topic: "serverless-logs"
      algorithm: "none"
      compression: "zstd"
      tls:
        status: true
```

### With Client ID

Configuration with client ID for tracking:

```yaml
targets:
  - name: msk_tracked
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9094
      topic: "tracked-logs"
      client_id: "datastream-producer-01"
      algorithm: "scram-sha-256"
      username: "kafka-producer"
      password: "password-here"
      compression: "lz4"
      tls:
        status: true
```

### Scheduled Batching

Configuration with scheduled batch delivery:

```yaml
targets:
  - name: scheduled_msk
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9094
      topic: "scheduled-logs"
      algorithm: "scram-sha-512"
      username: "kafka-producer"
      password: "password-here"
      max_events: 5000
      interval: "5m"
      compression: "gzip"
      tls:
        status: true
```

### Auto Topic Creation

Configuration with automatic topic creation enabled:

```yaml
targets:
  - name: auto_topic_msk
    type: amazonmsk
    properties:
      address: "b-1.mycluster.abc123.kafka.us-east-1.amazonaws.com"
      port: 9094
      topic: "dynamic-logs"
      algorithm: "scram-sha-256"
      username: "kafka-producer"
      password: "password-here"
      allow_auto_topic_creation: true
      compression: "snappy"
      max_events: 500
      tls:
        status: true
```